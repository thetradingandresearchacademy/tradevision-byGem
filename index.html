<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>TradeVision Pro â€“ SwingLab SaaS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root { --bg: #050505; --panel: #111; --accent: #D4AF37; --text: #fff; --success: #089981; }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    #auth-gate { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .auth-box { background: var(--panel); border: 1px solid #333; padding: 40px; border-radius: 8px; width: 380px; text-align: center; }
    #app-container { display: none; flex: 1; flex-direction: column; }
    header { padding: 15px 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
    main { flex: 1; display: grid; grid-template-columns: 320px 1fr; gap: 10px; padding: 10px; min-height: 0; }
    .panel { background: var(--panel); border: 1px solid #222; border-radius: 8px; padding: 20px; }
    #chartContainer { flex: 1; background: #000; border: 1px solid #222; border-radius: 4px; overflow: hidden; }
    input { width: 100%; background: #000; color: #fff; border: 1px solid #333; padding: 12px; margin-bottom: 10px; border-radius: 4px; }
    button { width: 100%; background: var(--accent); color: #000; border: none; padding: 14px; font-weight: bold; cursor: pointer; border-radius: 4px; text-transform: uppercase; }
  </style>
</head>
<body>

<div id="auth-gate">
  <div class="auth-box">
    <h2 style="color:var(--accent); margin-bottom:20px;">TRADEVISION PRO</h2>
    <div id="auth-error" style="color:#f23645; font-size:12px; margin-bottom:10px;"></div>
    <input type="email" id="email" placeholder="Email" value="admin@swinglab.pro" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="handleAuth()">ENTER WORKSPACE</button>
  </div>
</div>

<div id="app-container">
  <header>
    <div style="color:var(--accent); font-weight:bold; letter-spacing:1px;">SWINGLAB TERMINAL</div>
    <button onclick="location.reload()" style="background:none; border:1px solid #444; color:#888; cursor:pointer; padding:5px 10px; border-radius:4px;">LOGOUT</button>
  </header>
  <main>
    <section class="panel">
      <div style="font-size:11px; color:#888; margin-bottom:10px;">ENGINE CONTROL</div>
      <input id="symbol" type="text" placeholder="Ticker (e.g. SBIN)" />
      <button onclick="runSimulation()">REVEAL GLOW</button>
      <div id="status" style="margin-top:20px; display:none; font-size:12px;">
        <p>Fused Score: <span id="f-score" style="color:var(--accent)">--</span></p>
        <p>Astro Node: <span id="f-node" style="color:var(--success)">--</span></p>
      </div>
    </section>
    <section class="panel"><div id="chartContainer"></div></section>
  </main>
</div>

<script>
  // INITIALIZE FROM GLOBAL CONFIG
  const _supabase = supabase.createClient(window.SWINGLAB_CONFIG.SUPABASE_URL, window.SWINGLAB_CONFIG.SUPABASE_ANON_KEY);

  let chart, mainSeries, forecastSeries;

  async function handleAuth() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { data, error } = await _supabase.auth.signInWithPassword({ email, password });

    if (error) {
      document.getElementById('auth-error').innerText = error.message;
      return;
    }
    
    document.getElementById('auth-gate').style.display = 'none';
    document.getElementById('app-container').style.display = 'flex';
    initChart();
  }

  function initChart() {
    const container = document.getElementById('chartContainer');
    chart = LightweightCharts.createChart(container, {
      layout: { background: { color: '#000' }, textColor: '#D4AF37' },
      grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
      width: container.clientWidth,
      height: container.clientHeight,
    });
    mainSeries = chart.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645' });
    forecastSeries = chart.addCandlestickSeries({ upColor: '#D4AF37', downColor: '#AA8A2E' });
  }

  async function runSimulation() {
    const symbol = document.getElementById('symbol').value.trim().toUpperCase();
    if(!symbol) return;

    const response = await fetch('/api/get_glow', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ symbol })
    });
    
    const data = await response.json();
    if (data && data.historical) {
      mainSeries.setData(data.historical);
      forecastSeries.setData(data.forecast);
      document.getElementById('status').style.display = 'block';
      document.getElementById('f-score').innerText = data.fused_score;
      document.getElementById('f-node').innerText = data.temporal_node;
      chart.timeScale().fitContent();
    }
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>TradeVision Pro â€“ SwingLab SaaS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root {
      --bg: #050505; --bg-panel: #111111; --accent: #D4AF37; 
      --danger: #f23645; --text: #ffffff; --muted: #888888; --success: #089981;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg); color: var(--text); height: 100vh;
      display: flex; flex-direction: column; overflow: hidden;
    }

    /* AUTH GATE */
    #auth-gate {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(10px);
      z-index: 9999; display: flex; align-items: center; justify-content: center;
    }
    .auth-box {
      background: var(--bg-panel); border: 1px solid #333; border-radius: 8px;
      padding: 40px; width: 100%; max-width: 400px; text-align: center;
    }
    .auth-brand { font-size: 24px; color: var(--accent); letter-spacing: 0.1em; font-weight: bold; margin-bottom: 5px; }
    .auth-input { width: 100%; background: #000; border: 1px solid #333; color: var(--text); padding: 12px; margin-bottom: 15px; border-radius: 4px; }
    .auth-btn { width: 100%; background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 4px; font-weight: bold; cursor: pointer; }
    .auth-error { color: var(--danger); font-size: 12px; margin-bottom: 15px; min-height: 15px; }

    /* MAIN UI */
    #app-container { display: none; flex-direction: column; height: 100%; width: 100%; }
    header { padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; background: #0a0a0a; border-bottom: 1px solid #222; }
    header h1 { font-size: 18px; color: var(--accent); }
    .user-profile { display: flex; align-items: center; gap: 15px; }
    main { flex: 1; display: grid; grid-template-columns: 340px 1fr; gap: 12px; padding: 12px; min-height: 0; }
    .panel { background: var(--bg-panel); border-radius: 8px; border: 1px solid #222; padding: 14px; display: flex; flex-direction: column; }
    #chartContainer { flex: 1; background: #000; border-radius: 4px; border: 1px solid #222; }
    .btn-primary { background: var(--accent); color: #000; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

<div id="auth-gate">
  <div class="auth-box">
    <div class="auth-brand">TRADEVISION PRO</div>
    <div id="auth-error-msg" class="auth-error"></div>
    <input type="email" id="email-input" class="auth-input" placeholder="Email" />
    <input type="password" id="password-input" class="auth-input" placeholder="Password" />
    <button class="auth-btn" onclick="handleAuth()">Sign In to Workspace</button>
  </div>
</div>

<div id="app-container">
  <header>
    <h1>TRADEVISION PRO</h1>
    <div class="user-profile">
      <span id="display-email" class="user-email"></span>
      <span style="font-size: 10px; color: var(--accent); border: 1px solid var(--accent); padding: 2px 6px; border-radius: 3px;">PRO TIER</span>
      <button onclick="logout()" style="background:none; border:none; color:var(--muted); cursor:pointer;">Logout</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <div style="font-size: 11px; color: var(--muted); margin-bottom: 10px;">ðŸ“¡ SYSTEM CONTROL</div>
      <div style="display:flex; gap:8px;">
        <input id="symbolInput" type="text" placeholder="Symbol (e.g., RELIANCE)" style="flex:1; background:#000; color:#fff; border:1px solid #333; padding:5px; border-radius:4px;" />
        <button class="btn-primary" onclick="loadSimulation()">LOAD ENGINE</button>
      </div>
      
      <div id="engine-stats" style="margin-top:20px; font-size:12px; display:none;">
        <p>Fused Score: <span id="stat-score" style="color:var(--accent)">--</span></p>
        <p>Astro Node: <span id="stat-node" style="color:var(--success)">--</span></p>
      </div>
    </section>

    <section class="panel">
      <div id="chartContainer"></div>
    </section>
  </main>
</div>

<script>
  // 1. Initialize Supabase
  const SUPABASE_URL = 'https://your-project.supabase.co';
  const SUPABASE_KEY = 'your-anon-key';
  const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let chart, mainSeries, forecastSeries;

  // 2. Auth Logic
  async function handleAuth() {
    const email = document.getElementById('email-input').value;
    const password = document.getElementById('password-input').value;
    const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
    
    if (error) return document.getElementById('auth-error-msg').innerText = error.message;
    
    document.getElementById('auth-gate').style.display = 'none';
    document.getElementById('app-container').style.display = 'flex';
    document.getElementById('display-email').innerText = data.user.email;
    initChart();
  }

  // 3. Chart Initialization
  function initChart() {
    chart = LightweightCharts.createChart(document.getElementById('chartContainer'), {
      layout: { background: { color: '#050505' }, textColor: '#D4AF37' },
      grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
    });
    mainSeries = chart.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645' });
    forecastSeries = chart.addCandlestickSeries({ upColor: '#D4AF37', downColor: '#AA8A2E', borderVisible: true });
  }

  // 4. Load Engine Logic (The 0.55/0.45 Trigger)
  async function loadSimulation() {
    const symbol = document.getElementById('symbolInput').value;
    // Call the Edge Function we built earlier
    const { data, error } = await _supabase.functions.invoke('swinglab-engine', { body: { symbol } });

    if (data) {
      mainSeries.setData(data.historical);
      forecastSeries.setData(data.forecast);
      
      document.getElementById('engine-stats').style.display = 'block';
      document.getElementById('stat-score').innerText = data.fused_score;
      document.getElementById('stat-node').innerText = data.temporal_node;
    }
  }

  async function logout() { await _supabase.auth.signOut(); location.reload(); }
</script>
</body>
</html>

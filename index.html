<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>TradeVision Pro | SwingLab SaaS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root { --bg: #050505; --panel: #0d0d0d; --accent: #D4AF37; --text: #ffffff; --border: #222; --success: #089981; }
    body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    
    /* LOGIN OVERLAY */
    #auth-gate { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .auth-box { background: var(--panel); border: 1px solid var(--border); padding: 40px; border-radius: 12px; width: 380px; text-align: center; box-shadow: 0 0 50px rgba(212,175,55,0.05); }
    
    /* TERMINAL LAYOUT */
    #app-container { display: none; flex: 1; flex-direction: column; }
    header { height: 60px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; background: #000; border-bottom: 1px solid var(--border); }
    
    /* SAAS SEARCH BAR */
    .search-container { position: relative; width: 400px; }
    #symbolSearch { width: 100%; background: #111; border: 1px solid var(--border); color: #fff; padding: 10px 15px; border-radius: 6px; font-size: 14px; outline: none; transition: border 0.2s; }
    #symbolSearch:focus { border-color: var(--accent); }

    main { flex: 1; display: grid; grid-template-columns: 320px 1fr; gap: 1px; background: var(--border); }
    .sidebar { background: var(--panel); padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    .chart-area { background: #000; position: relative; overflow: hidden; }
    #chartContainer { width: 100%; height: 100%; }

    .metric-card { background: #111; border: 1px solid var(--border); padding: 15px; border-radius: 8px; }
    .metric-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .metric-value { font-size: 18px; font-weight: bold; color: var(--accent); }

    button.auth-btn { width: 100%; background: var(--accent); border: none; padding: 14px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; }
  </style>
</head>
<body>

<div id="auth-gate">
  <div class="auth-box">
    <h1 style="color:var(--accent); font-size:24px; margin-bottom:5px;">TRADEVISION PRO</h1>
    <p style="font-size:11px; color:#555; margin-bottom:25px;">TARA SWINGLAB ENGINE | v2.0</p>
    <div id="auth-err" style="color:#f23645; font-size:12px; margin-bottom:10px;"></div>
    <input type="email" id="email" class="search-input" placeholder="Email" style="width:100%; background:#000; color:#fff; border:1px solid #333; padding:12px; margin-bottom:10px; border-radius:4px;" />
    <input type="password" id="pass" class="search-input" placeholder="Password" style="width:100%; background:#000; color:#fff; border:1px solid #333; padding:12px; margin-bottom:10px; border-radius:4px;" />
    <button class="auth-btn" onclick="handleAuth()">LOGIN TO TERMINAL</button>
  </div>
</div>

<div id="app-container">
  <header>
    <div style="font-weight:bold; letter-spacing:1px; color:var(--accent);">SWINGLAB</div>
    <div class="search-container">
      <input type="text" id="symbolSearch" placeholder="SEARCH TICKER (e.g. SBIN)..." onkeydown="if(event.key==='Enter') triggerEngine()" />
    </div>
    <button onclick="location.reload()" style="background:none; border:none; color:#555; cursor:pointer; font-size:12px;">LOGOUT</button>
  </header>

  <main>
    <aside class="sidebar">
      <div class="metric-card">
        <div class="metric-label">Engine Fused Score</div>
        <div id="m-score" class="metric-value">--</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Temporal Logic Node</div>
        <div id="m-node" class="metric-value" style="color:var(--success); font-size:14px;">WATING...</div>
      </div>
      <div style="margin-top:auto; font-size:10px; color:#444;">Connected to Angel One API | Vault Secured</div>
    </aside>

    <section class="chart-area">
      <div id="chartContainer"></div>
    </section>
  </main>
</div>

<script>
  // SECURE INITIALIZATION
  const _supabase = supabase.createClient(window.SWINGLAB_CONFIG.SUPABASE_URL, window.SWINGLAB_CONFIG.SUPABASE_ANON_KEY);
  let chart, mainSeries, forecastSeries;

  async function handleAuth() {
    const { data, error } = await _supabase.auth.signInWithPassword({
      email: document.getElementById('email').value,
      password: document.getElementById('pass').value
    });
    if (error) return document.getElementById('auth-err').innerText = error.message;
    
    document.getElementById('auth-gate').style.display = 'none';
    document.getElementById('app-container').style.display = 'flex';
    initChart();
  }

  function initChart() {
    const container = document.getElementById('chartContainer');
    chart = LightweightCharts.createChart(container, {
      layout: { background: { color: '#000' }, textColor: '#D4AF37' },
      grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
      width: container.clientWidth,
      height: container.clientHeight,
    });
    mainSeries = chart.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645' });
    forecastSeries = chart.addCandlestickSeries({ upColor: '#D4AF37', downColor: '#AA8A2E' });
  }

  async function triggerEngine() {
    const symbol = document.getElementById('symbolSearch').value.trim().toUpperCase();
    if(!symbol) return;

    // FEEDBACK
    document.getElementById('m-node').innerText = "SYNCING ENGINE...";
    
    const response = await fetch('/api/get_glow', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ symbol })
    });
    
    const data = await response.json();
    if (data && data.historical) {
      mainSeries.setData(data.historical);
      forecastSeries.setData(data.forecast);
      document.getElementById('m-score').innerText = data.fused_score;
      document.getElementById('m-node').innerText = data.temporal_node;
      chart.timeScale().fitContent();
    }
  }
</script>
</body>
</html>
